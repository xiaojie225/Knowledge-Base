
# 微信订阅消息开发文档 - 总览

## 文档概述

本文档系列详细介绍了微信小程序订阅消息的完整开发流程,包括学习路径、部署配置、API使用和实战案例。订阅消息是小程序向用户推送服务通知的重要能力,支持一次性订阅和长期订阅两种模式。

---

## 文档目录

本学习文档分为以下几个部分:

### 1. [订阅消息开发指南](wechat-subscribe-msg-guide)
- 使用说明与完整流程
- 订阅消息类型介绍
- 事件推送机制
- 语音提醒与添加提醒功能

### 2. [API接口文档 - wx.requestSubscribeMessage](wechat-subscribe-msg-api)
- 接口功能与参数详解
- 调用时机与限制
- 错误码说明
- 代码示例

### 3. [辅助工具 - wx.getAccountInfoSync](wechat-account-info-api)
- 获取小程序账号信息
- 版本号管理
- 插件信息获取

---

## 快速开始指南

### 核心三步走

#### 步骤一: 获取模板ID
登录 [微信公众平台](https://mp.weixin.qq.com) → 功能 → 订阅消息 → 选择或添加模板

#### 步骤二: 调用订阅接口
```javascript
wx.requestSubscribeMessage({
  tmplIds: ['模板ID'],
  success(res) {
    console.log('订阅成功', res)
  }
})
```

#### 步骤三: 服务端发送消息
调用服务端接口 `subscribeMessage.send` 向用户推送消息

---

##  核心概念

### 订阅消息类型

| 类型 | 说明 | 使用场景 |
|------|------|---------|
| **一次性订阅** | 用户授权后可发送一次消息 | 临时通知、单次提醒 |
| **长期订阅** | 用户授权后可长期发送消息 | 周期性服务、持续关注 |
| **设备订阅** | 针对IoT设备的订阅消息 | 智能硬件通知 |

### 发送限制

- **开通支付**: 3000万/日
- **未开通支付**: 1000万/日

---

## ⚠️ 重要注意事项

### 版本要求
- 基础库版本 ≥ 2.4.4
- iOS 7.0.6+ / Android 7.0.7+ (多模板支持)
- 基础库 2.8.2+ 需用户点击或支付后才可调起

### 使用限制
1. 一次调用最多订阅 **3条** 消息
2. 模板标题不能重复
3. 用户选择"总是保持"后,下次不再弹窗
4. 基础库 2.10.0+ 禁止使用 formId

---

## 相关资源

- [微信公众平台](https://mp.weixin.qq.com)
- [小程序开发文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [服务端API文档](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html)

---

## 阅读顺序建议

### 新手开发者
1. 先阅读 **订阅消息开发指南**,了解整体流程
2. 查看 **API接口文档**,学习具体调用方法
3. 参考代码示例,动手实践

### 有经验开发者
- 直接查阅 API 文档定位具体问题
- 查看错误码表排查异常
- 了解语音提醒等高级特性

---

## 文档更新日志

- **2025-01-20**: 创建文档,整合官方最新内容
- 基于基础库 2.22.0+ 特性

---

**下一步**: 请点击具体章节链接深入学习各模块内容



# 微信小程序订阅消息开发指南

## �� 文档概述

本文档详细介绍微信小程序订阅消息的完整开发流程,包括功能介绍、使用步骤、事件推送机制和高级特性。适合小程序开发者学习和查阅。

---

## 目录

- [1. 订阅消息简介](#1-订阅消息简介)
- [2. 使用步骤](#2-使用步骤)
  - [2.1 步骤一: 获取模板ID](#21-步骤一-获取模板id)
  - [2.2 步骤二: 获取下发权限](#22-步骤二-获取下发权限)
  - [2.3 步骤三: 调用接口下发消息](#23-步骤三-调用接口下发消息)
- [3. 注意事项](#3-注意事项)
- [4. 订阅消息事件推送](#4-订阅消息事件推送)
  - [4.1 用户订阅行为推送](#41-用户订阅行为推送)
  - [4.2 用户管理消息推送](#42-用户管理消息推送)
  - [4.3 消息下发结果推送](#43-消息下发结果推送)
- [5. 高级特性](#5-高级特性)
  - [5.1 订阅消息语音提醒](#51-订阅消息语音提醒)
  - [5.2 订阅消息添加提醒](#52-订阅消息添加提醒)
- [6. 最佳实践](#6-最佳实践)
- [7. 常见问题FAQ](#7-常见问题faq)

---

## 1. 订阅消息简介

### 什么是订阅消息?

订阅消息是小程序向用户推送服务通知的官方能力,用户主动订阅后,小程序可以在特定场景下向用户发送消息提醒。

### 核心特点

- ✅ **用户主动订阅**: 保护用户体验,避免骚扰
- ✅ **类型多样**: 支持一次性、长期、设备订阅
- ✅ **场景丰富**: 覆盖物流、预约、提醒等多种业务
- ✅ **可管理**: 用户可随时取消订阅

### 订阅类型对比

| 类型 | 有效期 | 适用场景 | 获取方式 |
|------|--------|---------|---------|
| **一次性订阅** | 一次 | 订单通知、预约提醒 | wx.requestSubscribeMessage |
| **长期订阅** | 长期有效 | 周期性服务、持续关注 | wx.requestSubscribeMessage |
| **设备订阅** | 设备绑定期间 | IoT设备消息 | wx.requestSubscribeDeviceMessage |

---

## 2. 使用步骤

### 2.1 步骤一: 获取模板ID

#### 操作路径
1. 登录 [微信公众平台](https://mp.weixin.qq.com)
2. 进入 **功能** → **订阅消息**
3. 选择合适的模板或申请新模板

#### 模板示例

![订阅消息模板](https://res.wx.qq.com/wxdoc/dist/assets/img/subscribe-message.b562750a.jpg)

#### 获取模板ID
- 模板审核通过后,可在列表中查看模板ID
- 格式示例: `VRR0UEO9VJOLs0MHlU0OilqX6MVFDwH3_3gz3Oc0NIc`

---

### 2.2 步骤二: 获取下发权限

#### 一次性/长期订阅消息

```javascript
// 调用订阅接口
wx.requestSubscribeMessage({
  tmplIds: [
    'VRR0UEO9VJOLs0MHlU0OilqX6MVFDwH3_3gz3Oc0NIc',
    '9nLIlbOQZC5Y89AZteFEux3WCXRRRG5Wfzkpssu4bLI'
  ],
  success(res) {
    console.log('订阅结果:', res)
    // res 示例:
    // {
    //   "VRR0UEO9VJOLs0MHlU0OilqX6MVFDwH3_3gz3Oc0NIc": "accept",
    //   "9nLIlbOQZC5Y89AZteFEux3WCXRRRG5Wfzkpssu4bLI": "reject"
    // }
  },
  fail(err) {
    console.error('订阅失败:', err)
  }
})
```

#### 设备订阅消息

```javascript
wx.requestSubscribeDeviceMessage({
  tmplIds: ['模板ID'],
  sn: '设备序列号',
  snTicket: '设备票据',
  modelId: '设备型号ID',
  success(res) {
    console.log('设备订阅成功', res)
  }
})
```

#### 订阅结果说明

| 返回值 | 说明 | 后续操作 |
|-------|------|---------|
| `accept` | 用户同意订阅 | 可发送消息 |
| `reject` | 用户拒绝订阅 | 不可发送 |
| `ban` | 模板被封禁 | 联系平台 |
| `filter` | 标题重复被过滤 | 检查模板 |
| `acceptWithAudio` | 同意+语音提醒 | 可发送+语音 |
| `acceptWithAlert` | 同意+添加提醒 | 可发送+横幅 |

---

### 2.3 步骤三: 调用接口下发消息

#### 服务端接口调用

**接口地址**:
```
POST https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=ACCESS_TOKEN
```

**请求参数**:
```json
{
  "touser": "用户openid",
  "template_id": "模板ID",
  "page": "pages/index/index",
  "data": {
    "thing1": {
      "value": "订单号:12345"
    },
    "time2": {
      "value": "2025-01-20 10:30"
    },
    "amount3": {
      "value": "99.00元"
    }
  },
  "miniprogram_state": "formal"
}
```

**发送次数限制**:
- 开通支付: **30,000,000次/日**
- 未开通支付: **10,000,000次/日**

---

## 3. 注意事项

### ⚠️ 版本要求

| 项目 | 最低版本 |
|------|---------|
| 基础库 | 2.4.4 |
| iOS多模板 | 7.0.6 |
| Android多模板 | 7.0.7 |
| 点击触发限制 | 2.8.2 |
| 禁用formId | 2.10.0 |

### ⚠️ 调用限制

1. **触发条件** (基础库 2.8.2+)
   - 用户点击行为后
   - 支付回调后
 
2. **数量限制**
   - 单次最多订阅 **3条** 消息
   - 低版本(iOS 7.0.5/Android 7.0.6)仅支持1条

3. **模板要求**
   - 同一次调用中,模板标题不能重复
   - 重复标题会被自动过滤

4. **用户选择**
   - 勾选"总是保持以上选择"后,下次不再弹窗
   - 修改需进入小程序设置

---

## 4. 订阅消息事件推送

开发者可配置服务器地址或使用[微信云托管](https://developers.weixin.qq.com/miniprogram/dev/wxcloudrun/src/guide/weixin/push.html),接收订阅消息相关事件。

### 4.1 用户订阅行为推送

当用户触发订阅弹窗并做出选择时,会推送事件到开发者服务器。

#### XML格式示例

```xml
<xml>
  <ToUserName><![CDATA[gh_123456789abc]]></ToUserName>
  <FromUserName><![CDATA[otFpruAK8D-E6EfStSYonYSBZ8_4]]></FromUserName>
  <CreateTime>1610969440</CreateTime>
  <MsgType><![CDATA[event]]></MsgType>
  <Event><![CDATA[subscribe_msg_popup_event]]></Event>
  <SubscribeMsgPopupEvent>
    <List>
      <TemplateId><![CDATA[VRR0UEO9VJOLs0MHlU0OilqX6MVFDwH3_3gz3Oc0NIc]]></TemplateId>
      <SubscribeStatusString><![CDATA[accept]]></SubscribeStatusString>
      <PopupScene>2</PopupScene>
    </List>
  </SubscribeMsgPopupEvent>
</xml>
```

#### JSON格式示例

```json
{
  "ToUserName": "gh_123456789abc",
  "FromUserName": "o7esq5OI1Uej6Xixw1lA2H7XDVbc",
  "CreateTime": "1620973045",
  "MsgType": "event",
  "Event": "subscribe_msg_popup_event",
  "List": [{
    "TemplateId": "hD-ixGOhYmUfjOnI8MCzQMPshzGVeux_2vzyvQu7O68",
    "SubscribeStatusString": "accept",
    "PopupScene": "0"
  }]
}
```

#### 参数说明

| 参数 | 类型 | 说明 |
|------|------|------|
| ToUserName | String | 小程序账号ID |
| FromUserName | String | 用户openid |
| CreateTime | Number | 时间戳 |
| TemplateId | String | 模板ID |
| SubscribeStatusString | String | 订阅结果(accept/reject) |
| PopupScene | String | 弹框场景(0=小程序内) |

---

### 4.2 用户管理消息推送

用户在"服务通知"中管理订阅消息(设置拒收)时,推送取消订阅事件。

#### XML格式示例

```xml
<xml>
  <ToUserName><![CDATA[gh_123456789abc]]></ToUserName>
  <FromUserName><![CDATA[otFpruAK8D-E6EfStSYonYSBZ8_4]]></FromUserName>
  <CreateTime>1610969440</CreateTime>
  <MsgType><![CDATA[event]]></MsgType>
  <Event><![CDATA[subscribe_msg_change_event]]></Event>
  <SubscribeMsgChangeEvent>
    <List>
      <TemplateId><![CDATA[VRR0UEO9VJOLs0MHlU0OilqX6MVFDwH3_3gz3Oc0NIc]]></TemplateId>
      <SubscribeStatusString><![CDATA[reject]]></SubscribeStatusString>
    </List>
  </SubscribeMsgChangeEvent>
</xml>
```

#### JSON格式示例

```json
{
  "ToUserName": "gh_123456789abc",
  "FromUserName": "o7esq5OI1Uej6Xixw1lA2H7XDVbc",
  "CreateTime": "1610968440",
  "MsgType": "event",
  "Event": "subscribe_msg_change_event",
  "List": [{
    "TemplateId": "BEwX0BOT3MqK3Uc5oTU3CGBqzjpndk2jzUf7VfExd8",
    "SubscribeStatusString": "reject"
  }]
}
```

---

### 4.3 消息下发结果推送

调用服务端接口发送消息后,最终下发结果会推送到开发者服务器。

#### XML格式示例

```xml
<xml>
  <ToUserName><![CDATA[gh_123456789abc]]></ToUserName>
  <FromUserName><![CDATA[otFpruAK8D-E6EfStSYonYSBZ8_4]]></FromUserName>
  <CreateTime>1610969468</CreateTime>
  <MsgType><![CDATA[event]]></MsgType>
  <Event><![CDATA[subscribe_msg_sent_event]]></Event>
  <SubscribeMsgSentEvent>
    <List>
      <TemplateId><![CDATA[VRR0UEO9VJOLs0MHlU0OilqX6MVFDwH3_3gz3Oc0NIc]]></TemplateId>
      <MsgID>1700827132819554304</MsgID>
      <ErrorCode>0</ErrorCode>
      <ErrorStatus><![CDATA[success]]></ErrorStatus>
    </List>
  </SubscribeMsgSentEvent>
</xml>
```

#### 参数说明

| 参数 | 说明 |
|------|------|
| MsgID | 消息ID(调用接口时返回) |
| ErrorCode | 推送结果状态码(0=成功) |
| ErrorStatus | 状态码对应含义 |

**注意**: 失败仅包含因异步推送导致的系统失败。

---

## 5. 高级特性

### 5.1 订阅消息语音提醒

**支持版本**: 基础库 2.18.0+

#### 功能介绍

部分订阅消息模板支持语音提醒,用户订阅时可选择开启,接收消息时会播报语音。

#### 使用条件

1. 调用 `wx.requestSubscribeMessage` 时仅订阅 **1条** 消息
2. 该模板支持语音提醒功能
3. 用户主动勾选"开启语音提醒"

#### 订阅弹窗样式

![语音提醒弹窗](https://res.wx.qq.com/wxdoc/dist/assets/img/request-subscribe-message-with-audio.477c085f.png)

#### 获取订阅状态

```javascript
wx.getSetting({
  success(res) {
    const status = res.subscriptionsSetting.itemSettings
    // status['模板ID'] === 'acceptWithAudio' 表示开启语音
  }
})
```

#### 支持的模板类型

| 标题 | 类型 | 类目 | 播报语料 |
|------|------|------|---------|
| 收款到账通知 | 长期订阅 | 金融业-银行、金融业-收单商户服务 | "小程序示例收款10元"(示例会替换为小程序简称和金额) |

#### 无法播报的情况

1. ❌ 用户将服务通知设置为免打扰
2. ❌ 手机静音或音量过低
3. ❌ 未打开微信新消息通知
4. ❌ 未打开系统对微信的通知权限
5. ❌ 开启低电量模式
6. ❌ 版本过低(需 iOS 8.0.6+ / Android 8.0.3+)

---

### 5.2 订阅消息添加提醒

**支持版本**: 基础库 2.22.0+

#### 功能介绍

用户订阅**长期订阅消息**时,可根据使用情况添加提醒。添加后,消息将以横幅通知方式提醒用户。

#### 订阅弹窗样式

![添加提醒弹窗](https://res.wx.qq.com/wxdoc/dist/assets/img/subscribe-message-reminder.b26ab3eb.png)

#### 获取订阅状态

```javascript
wx.getSetting({
  success(res) {
    const status = res.subscriptionsSetting.itemSettings
    // status['模板ID'] === 'acceptWithAlert' 表示添加了提醒
  }
})
```

#### 横幅通知效果

用户收到消息时,微信内会显示横幅提醒,提升消息可见度。

---

## 6. 最佳实践

### 6.1 合理选择订阅时机

✅ **推荐场景**:
- 用户完成下单后,提示订阅物流消息
- 预约成功后,提示订阅预约提醒
- 支付成功后,提示订阅收款通知

❌ **避免场景**:
- 小程序启动立即弹窗
- 用户未操作时频繁提示
- 与当前场景无关的订阅请求

### 6.2 优化用户体验

```javascript
// 示例:下单后订阅物流消息
function subscribeLogistics() {
  wx.showModal({
    title: '开启物流通知',
    content: '订阅后可及时接收物流更新信息',
    success(res) {
      if (res.confirm) {
        wx.requestSubscribeMessage({
          tmplIds: ['物流模板ID'],
          success(subRes) {
            if (subRes['物流模板ID'] === 'accept') {
              wx.showToast({ title: '订阅成功' })
            }
          }
        })
      }
    }
  })
}
```

### 6.3 错误处理

```javascript
wx.requestSubscribeMessage({
  tmplIds: ['模板ID'],
  success(res) {
    // 记录订阅结果
    Object.keys(res).forEach(tmplId => {
      if (tmplId !== 'errMsg') {
        console.log(`模板${tmplId}:${res[tmplId]}`)
      }
    })
  },
  fail(err) {
    console.error('订阅失败:', err.errMsg)
    // 根据错误码处理
    if (err.errCode === 20004) {
      wx.showToast({
        title: '您已关闭消息推送',
        icon: 'none'
      })
    }
  }
})
```

---

## 7. 常见问题FAQ

### Q1: 为什么调用接口没有弹窗?

**A**: 检查以下几点:
1. 基础库版本 ≥ 2.4.4
2. 2.8.2+ 版本需在用户点击或支付后调用
3. 用户是否勾选了"总是保持以上选择"

### Q2: 如何让用户修改订阅选择?

**A**: 引导用户前往:
- 小程序右上角菜单 → 设置 → 通知管理

### Q3: 一次性订阅和长期订阅如何选择?

**A**: 
- **一次性**: 临时场景(订单通知、预约提醒)
- **长期**: 周期性服务(每日提醒、定期报告)

### Q4: 模板审核不通过怎么办?

**A**: 常见原因:
1. 标题不符合规范
2. 内容涉及营销推广
3. 场景说明不清晰
→ 根据拒绝理由修改后重新提交

### Q5: 如何提高订阅率?

**A**: 
1. 选择合适时机(完成操作后)
2. 清晰说明订阅价值
3. 避免频繁打扰用户
4. 发送高质量消息内容

---

## �� 相关文档

- [wx.requestSubscribeMessage API](wechat-subscribe-msg-api)
- [服务端消息发送接口](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html)
- [微信云托管消息推送](https://developers.weixin.qq.com/miniprogram/dev/wxcloudrun/src/guide/weixin/push.html)

---

**文档更新时间**: 2025-01-20
```
已成功为你创建了**微信订阅消息学习文档**系列的前两个文档:

1. **总览文档** - 提供整体导航和快速开始指南
2. **开发指南** - 详细介绍使用步骤、事件推送和高级特性

接下来我将继续创建API接口文档。由于token限制,我会创建精简但完整的版本: