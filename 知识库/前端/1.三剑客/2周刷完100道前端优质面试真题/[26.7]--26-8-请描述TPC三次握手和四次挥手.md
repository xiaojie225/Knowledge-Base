# TCP 三次握手和四次挥手详解

## 目录

- [面试要求与学习重点](#面试要求与学习重点)
- [握手与挥手的概念](#握手与挥手的概念)
- [三次握手详解](#三次握手详解)
- [数据传输过程](#数据传输过程)
- [四次挥手详解](#四次挥手详解)
- [TCP 与 HTTP 的关系](#tcp-与-http-的关系)
- [面试建议](#面试建议)
- [AI 总结](#ai-总结)

## 面试要求与学习重点

这是前端面试中非常常见的题目，每个同学面试前都应该准备。但需要注意以下几点：

- **不要追求过细的细节**：网上很多文章会描述得非常详细，涉及大量网络协议底层知识，比如数据包格式、包内数据的具体含义等。这些对开发工作没有实际指导价值，是操作系统和网络协议自动完成的部分。

- **关注核心问题**：
  - 为什么会有三次握手和四次挥手
  - 为什么是 3 次和 4 次
  - 握手和挥手分别是什么
  - 能够讲清楚整个过程
  - 理解本质原理和原因

- **面试评分标准**：
  - 追求 100 分的成本太高，几乎不可能（需要复习整本《计算机网络》教材）
  - 80 分就能通过面试，而且相对容易达到
  - 通过通俗易懂的讲解就能得到 80 分

## 握手与挥手的概念

**握手**和**挥手**这两个词非常形象：

- **握手**：表示友好，两个人见面握手，关系连接好了
  - 握手是 TCP 连接的过程
  - 需要 3 次握手才能建立连接

- **挥手**：表示告别，"轻轻地我走了，正如我轻轻地来，我挥一挥衣袖，不带走一片云彩"
  - 挥手是 TCP 的断开过程
  - 需要 4 次挥手才能断开连接

**协议层次区分**：
- 建立连接和断开连接：TCP 协议层面
- 传输内容：HTTP 协议层面
- 日常使用大部分是 HTTP 协议，但面试会更多考察 TCP 协议的原理

## 三次握手详解

### 建立连接的目的

建立 TCP 连接需要先确保双方都能收发消息，然后才能进行内容传输。

### 生活化类比

假设你想派人去朋友张三家取东西或送东西：

1. **不能直接去**：需要先打电话或发短信，问一问在不在家
2. **如果在家**：告诉对方等着，现在就派人去
3. **如果不在家**：去了就白跑一趟

建立连接就是这个打电话、发短信确认的过程。

### 三次握手过程

以客户端（我）和服务端（张三）为例：

**第一次握手**：
- 我发短信问张三："你在不在家？"
- 客户端发包，服务端接收
- 服务端知道：原来客户端要找我

**第二次握手**：
- 张三回复："我在家"
- 服务端发包，客户端接收
- 客户端知道：原来服务端已经收到消息了
- 此时双方已经相互证明对方有收发消息的能力

**第三次握手**：
- 我再发消息："好，你等着我，我这就过去"
- 客户端发包，服务端接收
- 服务端知道：客户端要准备发送了，我得准备好接收，不能随便关闭

### 为什么需要三次

- **前两次**：确定双方都有收发消息的能力，且同时在线
- **第三次**：客户端告诉服务端"别走，我要准备发送了"，服务端需要保持连接等待

三次握手完成后，连接才算真正建立，接下来立即开始收发消息。

### 专业流程图

虽然专业流程图中包含 SYN、ACK 等专业术语和数据包细节，但不需要纠结每个单词的含义、包的具体格式和内容。这些都是计算机网络底层的规定和 TCP 协议的实现细节，我们只需要理解三次握手的必要性即可。

## 数据传输过程

连接建立（establish）之后，就开始传输消息的过程。比如派人去张三家，一趟两趟把东西拿过来，这就是收发消息的过程。

## 四次挥手详解

### 为什么需要断开连接

传输完成后还没结束，因为还没有断开连接。如果张三一直等着你，或者你一直等着张三，这不合理。大家都很忙，传输完成后应该断开连接，各自干各自的事情。

断开之后，即使对方死机、掉线或停电都没关系。但在断开之前，不能出现这些情况，否则会影响整个完整的请求过程。

### 四次挥手过程

断开连接由客户端（主动方）发起，因为连接是客户端发起的，何时断开也由客户端决定。

**第一次挥手**：
- 我告诉张三："我完事了，我的请求已经发完了"
- 客户端发包，服务端接收
- 注意：此时不代表所有东西都传输完成，只是客户端没有更多请求了
- 但服务端可能还在继续传输数据

**第二次挥手**：
- 张三回复："好的，我知道了，我知道你没有请求了"
- 服务端发包，客户端接收
- 此时服务端可能还在继续传输数据给客户端
- 客户端进入等待状态

**第三次挥手**：
- 张三忙完后再发消息："行了，我该给你的东西都传完了，你可以完全断开了"
- 服务端发包，客户端接收
- 服务端表示自己已经传输完成

**第四次挥手**：
- 我告诉张三："行，我收到东西了，你就断开吧"
- 客户端发包，服务端接收
- 服务端收到后关闭连接

### 为什么需要四次

关键在于中间的两步为什么要分开：

1. **第一步**：客户端告诉服务端"我这儿没请求了，你那边忙完就可以断了"
2. **第二步**：服务端回复"好的"，然后继续忙
3. **第三步**：服务端忙完后回复"我这边已经忙完了，你看要不要断开"
4. **第四步**：客户端告诉服务端"行，断开吧"，然后断开

**为什么第二步和第三步要分开？**

因为一次 HTTP 请求看似是一次请求和一次响应，但在 TCP 底层，实际上可能发送了很多个数据包才能拼接出完整的结果。特别是传输大文件时，这种情况更加明显。

- 第二步只是确认"知道了客户端没有请求了"
- 但此时可能还有很多细节的数据包没有传输完成
- 第三步是真正传输完成后才能关闭
- 第一步完成后不能关闭，必须等全部完成后才能关闭

## TCP 与 HTTP 的关系

- **TCP 层**：负责建立连接（三次握手）和断开连接（四次挥手）
- **HTTP 层**：负责传输内容

我们看似的一次 HTTP 请求，在计算机内部可能发送了很多个 TCP 数据包，最后由计算机的网络模块帮我们拼接整合成完整的结果。这个过程对应用层是透明的，我们无法直接感知。

## 面试建议

遇到这个问题时的回答策略：

1. **画图说明**：可以画出三次握手和四次挥手的流程图，用箭头表示数据包的传输方向

2. **用通俗语言讲解**：
   - 握手是连接，三次握手是建立连接
   - 挥手是告别，四次挥手是断开连接
   - 结合生活化的例子（如打电话确认、派人取东西）来说明

3. **说明核心原理**：
   - 为什么需要三次：确保双方都能收发消息，且客户端通知服务端准备接收
   - 为什么需要四次：因为服务端可能还有数据没传输完，需要分两步确认

4. **不要过度深入**：千万不要追求过细的底层细节，否则会带来很大的学习成本。面试时间紧迫，需要把所有面试题都照顾一遍，不可能在这个题目上花费太多时间钻研细节。

## AI 总结

TCP 三次握手和四次挥手是网络通信中建立和断开连接的核心机制。三次握手确保通信双方都具备收发能力并准备好数据传输，而四次挥手则保证数据完全传输完成后才安全断开连接。理解这两个过程的关键在于把握其本质目的，而非纠结于底层协议的技术细节。在面试中，能够用通俗易懂的语言配合简单的流程图说明原理，就足以获得良好的评价。