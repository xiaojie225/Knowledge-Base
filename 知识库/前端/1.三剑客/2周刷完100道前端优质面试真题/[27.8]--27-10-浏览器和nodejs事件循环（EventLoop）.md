# 浏览器和 Node.js 事件循环（Event Loop）的区别

## 目录

- [基本概念](#基本概念)
- [Node.js 事件循环的宏任务分类](#nodejs-事件循环的宏任务分类)
- [微任务的优先级](#微任务的优先级)
- [代码示例演示](#代码示例演示)
- [执行顺序总结](#执行顺序总结)
- [注意事项](#注意事项)
- [AI 总结](#ai-总结)

## 基本概念

Node.js 和浏览器的事件循环机制基本相似，都遵循以下原则：
- 使用 ES 语法
- 单线程执行
- 需要事件循环机制
- 区分宏任务和微任务

**核心区别**：Node.js 的事件循环与浏览器的主要区别在于**宏任务的类型分类**和**优先级机制**。

## Node.js 事件循环的宏任务分类

Node.js 将宏任务划分为 6 个不同类型，按优先级从高到低排列：

1\. **Timers（定时器）**
   - 包括 `setTimeout` 和 `setInterval`
   - 优先级最高的宏任务类型

2\. **I/O Callbacks（I/O 回调）**
   - 处理网络、流、TCP 错误等回调
   - 优先级次于 Timers

3\. **Idle, Prepare**
   - Node.js 内部使用
   - 一般开发中用不到

4\. **Poll（轮询）**
   - 一般开发中较少直接使用

5\. **Check（检查）**
   - 执行 `setImmediate` 回调
   - 优先级低于 `setTimeout`

6\. **Close Callbacks（关闭回调）**
   - 如 `socket.on('close', callback)`
   - 优先级最低

## 微任务的优先级

Node.js 的微任务也有优先级区分：

1\. **`process.nextTick`**
   - 优先级最高的微任务
   - 甚至高于 Promise

2\. **Promise.then/catch/finally**
   - 标准的微任务

3\. **`async/await`**
   - 与 Promise 优先级相同

## 代码示例演示

```javascript
console.log('Start');
console.log('End');

setImmediate(() => {
  console.log('Immediate');
});

setTimeout(() => {
  console.log('Timeout');
}, 0);

Promise.resolve().then(() => {
  console.log('Promise');
});

process.nextTick(() => {
  console.log('nextTick');
});
```

**执行结果**：
```
Start
End
nextTick
Promise
Timeout
Immediate
```

**执行顺序解析**：
1. 同步代码：`Start` → `End`
2. 微任务（优先级高）：`nextTick`（最高优先级）→ `Promise`
3. 宏任务（按类型优先级）：`setTimeout`（Timers 类型）→ `setImmediate`（Check 类型）

## 执行顺序总结

Node.js 事件循环的完整执行流程：

1. **执行同步代码**
2. **执行所有微任务**
   - 优先执行 `process.nextTick` 队列
   - 再执行 Promise 队列
3. **按优先级执行宏任务**
   - 每开始一个宏任务类型之前，先检查并执行当前的所有微任务
   - 按照 6 个类型的顺序依次执行：Timers → I/O Callbacks → Idle/Prepare → Poll → Check → Close Callbacks
4. **循环往复**

关键点：**每个宏任务类型开始之前都要先执行当前的微任务队列**，因为微任务的优先级本身就高于宏任务。

## 注意事项

1\. **推荐使用 `setImmediate` 代替 `process.nextTick`**
   - 新版本 Node.js 推荐使用 `setImmediate`
   - 原因：`process.nextTick` 优先级过高，如果执行繁重任务可能导致后续任务卡顿
   - 除非有紧急任务需要立即执行，否则使用 `setImmediate` 更合理

2\. **版本差异**
   - 本说明基于 Node.js 较新版本（如 v16）
   - 低版本 Node.js 可能存在行为差异
   - 在旧版本中可能出现与演示不一致的情况

3\. **与浏览器的对比**
   - 浏览器的宏任务和微任务没有类型和优先级的细分
   - 浏览器中谁先注册谁先执行
   - Node.js 必须按照类型优先级执行

## AI 总结

Node.js 与浏览器的事件循环核心区别在于任务的分类和优先级机制。Node.js 将宏任务细分为 6 种类型（Timers、I/O Callbacks、Idle/Prepare、Poll、Check、Close Callbacks），按优先级顺序执行；微任务中 `process.nextTick` 优先级最高，高于 Promise。执行流程为：同步代码 → 微任务（nextTick → Promise）→ 宏任务（按类型优先级），每个宏任务类型开始前都会先清空微任务队列。新版本推荐使用 `setImmediate` 代替 `process.nextTick` 以避免阻塞。