# HTTP跨域时为何要发送OPTIONS请求

## 目录

- [跨域请求基础](#跨域请求基础)
- [同源策略的限制范围](#同源策略的限制范围)
- [跨域解决方案](#跨域解决方案)
  - [JSONP方案](#jsonp方案)
  - [CORS方案](#cors方案)
- [OPTIONS预检请求](#options预检请求)
- [AI 总结](#ai-总结)

## 跨域请求基础

**同源策略**是浏览器的安全机制，不允许网页去请求第三方域名的资源，特别是获取敏感数据。如果不限制：

- 可以轻松在浏览器上调用百度、淘宝等第三方接口
- 数据会不够隔离，造成安全漏洞
- 浏览器将不可用

## 同源策略的限制范围

同源策略主要限制 **AJAX网络请求**，但**不会限制**以下静态资源：

- `<link>` 加载的 CSS 文件
- `<img>` 加载的图片
- `<script>` 加载的 JS 文件
- `<iframe>` 加载的第三方网页

**原因**：这些静态资源的设计目的就是为了向第三方扩散，与服务端的私密数据不同。服务端数据往往需要登录后才能请求。

## 跨域解决方案

### JSONP方案

JSONP 是比较古老但依然在用的跨域方法，利用 `<script>` 标签不受同源策略限制的特性。

**实现原理**：

1\. 在 `AA.com` 网页中定义一个全局函数：
```javascript
function onSuccess(data) {
  console.log(data);
}
```

2\. 通过 `<script>` 标签请求 `BBB.com` 的接口：
```html
<script src="http://BBB.com/api?callback=onSuccess"></script>
```

3\. `BBB.com` 接口返回一个字符串：
```javascript
onSuccess({name: "data"})
```

4\. 浏览器将返回的字符串当作 JS 执行，自动调用 `onSuccess` 函数，完成数据传递

**特点**：通过旁门左道走通了跨域方案，需要服务端配合

### CORS方案

CORS (Cross-Origin Resource Sharing) 是现代标准的跨域解决方案。

**实现方法**：服务端在响应头中设置允许跨域的声明：

```
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, POST, PUT, DELETE
Access-Control-Allow-Headers: Content-Type
```

**特点**：

- 正儿八经针对跨域的解决方案
- 名字就是"访问控制"，专门给跨域相关权限
- 比 JSONP 更简洁，但同样需要服务端配合

## OPTIONS预检请求

### 什么是OPTIONS请求

在跨域请求之前，浏览器可能会自动发起一个 `Method` 为 `OPTIONS` 的请求。

### 为什么需要OPTIONS请求

OPTIONS 请求是**跨域请求的预检查**：

1. 在发送真正的跨域请求（如 DELETE）之前，先检查服务端是否支持该方法
2. OPTIONS 响应头会返回 `Allow-Methods`，包含服务端支持的方法列表：
   ```
   Allow-Methods: GET, POST, PUT, PATCH, DELETE, OPTIONS
   ```
3. 浏览器检查后，如果支持目标方法，才会发送真正的请求
4. 如果不支持，会继续报其他错误

### 重要特性

- **浏览器自行发起**：不需要开发者干预
- **不影响实际开发**：可以忽略，不影响功能
- **预检查机制**：确保服务端能满足当前请求的能力

### 开发建议

- 如果不知道 OPTIONS 请求，忽略即可，不影响开发
- 遇到 OPTIONS 请求报错时，根据预检查思路排查是否有检查未通过的情况
- 无需深究更细节的原理，掌握基本背景和价值即可

## AI 总结

本视频讲解了 HTTP 跨域时的 OPTIONS 预检请求机制。核心要点：

1. **同源策略**限制跨域 AJAX 请求，但不限制静态资源加载
2. **跨域解决方案**包括 JSONP（利用 script 标签）和 CORS（服务端设置响应头）
3. **OPTIONS 预检请求**是浏览器在跨域请求前自动发起的检查，用于确认服务端是否支持目标请求方法
4. OPTIONS 请求由浏览器自动处理，开发者无需干预，不影响实际功能开发

理解 OPTIONS 请求的背景和作用即可，无需过度深究细节原理。