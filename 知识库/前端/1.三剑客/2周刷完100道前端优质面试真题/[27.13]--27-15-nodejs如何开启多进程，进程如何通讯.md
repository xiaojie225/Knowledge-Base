# Node.js 多进程开启与通信 - Cluster 方式

## 目录

- [Cluster 基本使用](#cluster-基本使用)
- [主进程与子进程的职责](#主进程与子进程的职责)
- [进程守护机制](#进程守护机制)
- [端口共享原理](#端口共享原理)
- [实际工作中的最佳实践](#实际工作中的最佳实践)
- [Cluster vs Child Process Fork](#cluster-vs-child-process-fork)
- [进程与线程的区别](#进程与线程的区别)
- [AI 总结](#ai-总结)

## Cluster 基本使用

Cluster 是 Node.js 内置模块，用于实现多进程服务。使用前需要引入：

```javascript
const cluster = require('cluster');
const http = require('http');
const os = require('os');
```

### 确定进程数量

开启的进程数量应该等于 CPU 核心数，这样可以充分利用多核 CPU 的计算能力：

```javascript
const numCPUs = os.cpus().length;
```

- CPU 是双核的，就开两个进程
- CPU 是四核的，就开四个进程
- 这是最合适的配置方式

## 主进程与子进程的职责

### 主进程（Master）

主进程的作用是派生子进程，不直接提供服务：

```javascript
if (cluster.isMaster) {
  // 根据 CPU 核数开启子进程
  for (let i = 0; i < numCPUs; i++) {
    cluster.fork();
  }
}
```

`cluster.fork()` 的含义：
- fork 是"叉"的意思，就是分叉
- 实际作用是开启子进程

### 子进程（Worker）

子进程负责实际的服务提供：

```javascript
else {
  // 创建 HTTP 服务
  http.createServer((request, response) => {
    response.writeHead(200);
    response.end('done');
  }).listen(3000);
}
```

## 进程守护机制

当子进程因错误退出时，需要自动补充新的进程，这就是**进程守护**：

```javascript
cluster.on('exit', (worker, code, signal) => {
  console.log('子进程退出');
  cluster.fork(); // 重新启动一个子进程
})
```

工作原理：
- 假设开启了 4 个子进程
- 其中一个因为某种原因崩溃退出
- 系统自动检测到退出事件
- 立即启动一个新的子进程补上
- 保证服务的稳定性和可用性

## 端口共享原理

多个子进程可以监听同一个端口而不会冲突，原因是：

**多个子进程会共享一个 TCP 连接，共同提供一份网络服务**

- 对客户端来说：看到的是一个统一的服务（黑盒）
- 对服务器内部来说：由多个进程共同维持
- 这种方式大幅提高了服务器性能和并发处理能力

## 实际工作中的最佳实践

### 使用 PM2 工具

在实际工作中，不建议手写多进程管理代码，而是使用成熟的工具：

**PM2** 是业界标准的 Node.js 进程管理工具：
- 下载量非常大
- 自动完成进程守护
- 自动开启多个进程服务
- 处理各种边界情况
- 配置简单，功能强大
- 开源且免费

可以从 NPM 搜索并安装 PM2。

## Cluster vs Child Process Fork

两种方式的使用场景不同：

### Cluster
- **用途**：开启多个进程提供服务
- **场景**：Web 服务器、API 服务等需要高并发的场景
- **特点**：多个进程共享端口，对外提供统一服务

### Child Process Fork
- **用途**：单独的计算任务
- **场景**：计算量大的任务，需要独立进程处理
- **特点**：不建议开启多个服务，主要用于数据计算
- **工作流程**：主进程开启子进程 → 子进程完成计算 → 返回数据给主进程

## 进程与线程的区别

### 核心概念

**进程（Process）**：
- 资源调度的单位
- 用于分配内存
- Node.js 可以开启多进程

**线程（Thread）**：
- 计算的单位
- 用于执行计算任务
- **JavaScript 永远是单线程的，没有多线程**

### 为何需要多进程

从两个方面考虑：

1. **CPU 角度**：充分利用多核 CPU 的计算能力
2. **内存角度**：更好地分配和利用服务器内存资源

目标是最大化利用服务器或电脑的性能和硬件资源。

### 与其他语言对比

JavaScript 只能开启多进程来做服务和计算，这一点可以和 Java、C++ 等支持多线程的语言进行对比。

## AI 总结

本视频详细讲解了 Node.js 中使用 Cluster 模块实现多进程的方法。核心要点包括：根据 CPU 核数开启相应数量的子进程，主进程负责派生和守护子进程，子进程负责实际服务。多个子进程可以共享同一 TCP 连接和端口，对外提供统一服务。实际工作中推荐使用 PM2 工具进行进程管理。Cluster 适合开启多进程服务，而 Child Process Fork 适合处理独立的计算任务。需要明确 JavaScript 是单线程语言，只能通过多进程来提升性能。