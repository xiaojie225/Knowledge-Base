## 目录

- [什么是 JS Bridge](#什么是-js-bridge)
- [JS Bridge 的应用场景](#js-bridge-的应用场景)
- [JS Bridge 的实现原理](#js-bridge-的实现原理)
  - [方式一：注册全局 API](#方式一注册全局-api)
  - [方式二：URL Scheme](#方式二url-scheme)
- [URL Scheme 的封装实现](#url-scheme-的封装实现)
- [AI 总结](#ai-总结)

---

## 什么是 JS Bridge

JS Bridge 是一种让网页中的 JavaScript 能够调用 Native API（原生 APP 能力）的技术方案。

**核心问题**：H5 网页中的 JS 无法直接调用 Native API，需要通过特殊的桥接方式来实现通信。

**典型案例**：微信 JS SDK 是最常用的 JS Bridge 实现，它封装了微信 APP 的各种原生能力供网页调用。

## JS Bridge 的应用场景

微信 JS SDK 提供的能力包括：

- 拍照、预览图片、上传图片、下载图片
- 录音、停止录音、上传语音接口
- 扫一扫
- 获取地理位置
- 分享到朋友圈、分享到 QQ 等社交功能

这些都是微信 APP 本身的原生能力，通过 JS Bridge 封装后让网页 JS 可以调用。

## JS Bridge 的实现原理

### 整体架构

```
OS 操作系统
  └── APP（如微信）
      └── WebView 组件
          └── H5 网页
```

**关键点**：
- APP 内嵌 WebView 组件来承载和展示 H5 网页
- 浏览器（如 Chrome、Safari）本质上也是以 WebView 为核心的 APP
- 微信不是浏览器，但内部有 WebView 组件用于显示网页
- 网页中的 JS 想要调用 APP 级别的能力（如拍照、扫一扫、获取地理位置），必须通过 APP 向 WebView 注入的 API 或能力来实现

**JS Bridge 的本质**：就是一堆 JS 代码，对 APP 提供的能力进行封装。

### 方式一：注册全局 API

**原理**：APP 直接在 WebView 的 `window` 对象上注册全局属性或方法。

**示例代码**：

```javascript
// APP 在 WebView 中注册全局 API
window.getVersion = function() {
  return "微信版本号";
}

// 网页中调用
const version = window.getVersion();
console.log(version);
```

**优点**：实现简单，适合同步操作

**缺点**：
- 不适合异步场景
- 如果需要 APP 通过网络请求或读取本地文件获取信息，会导致卡顿
- 只适用于简单的同步信息获取

### 方式二：URL Scheme

**原理**：通过自定义协议（URL Scheme）实现 APP 与网页的通信。

**标准协议 vs 自定义协议**：
- 标准协议：`http://`、`https://`
- 自定义协议：`myappname://api/getVersion`、`weixin://dl/feedback`

**工作流程**：

1. 网页创建 iframe 并设置 `src` 为自定义协议的 URL
2. WebView 加载资源时会先经过 APP 层
3. APP 拦截请求，识别到自定义协议
4. APP 直接处理请求并返回结果，不再发送到网络
5. 对于标准协议（http/https），APP 按正常流程处理

**微信 URL Scheme 示例**：
- `weixin://dl/feedback` - 反馈
- `weixin://dl/moments` - 朋友圈
- `weixin://dl/scan` - 扫一扫
- `weixin://dl/settings` - 设置

**支付宝 URL Scheme 示例**：
- `alipays://platformapi/startapp?appId=xxx` - 启动小程序
- `alipay://platformapi/dino` - 小游戏（跳一跳）

**基础实现**：

```javascript
// 创建 iframe
const iframe1 = document.getElementById('iframe1');

// 设置自定义协议 URL
iframe1.src = 'myappname://api/getVersion';

// 监听加载完成
iframe1.onload = function() {
  const content = iframe1.contentWindow.document.body.innerHTML;
  console.log(content);
}
```

**优点**：
- 支持异步操作
- iframe 加载本身就是异步的
- 适用于所有场景

## URL Scheme 的封装实现

为了让 URL Scheme 方式更优雅，需要进行封装，避免在页面上一直存在 iframe 元素。

**SDK 封装代码**：

```javascript
const SDK = {
  // 核心调用方法
  invoke: function(url, data, success, error) {
    // 动态创建 iframe
    const iframe = document.createElement('iframe');
    
    // 隐藏 iframe
    iframe.style.visibility = 'hidden';
    
    // 添加到页面
    document.body.appendChild(iframe);
    
    // 设置 URL，拼接数据
    iframe.src = url + '?data=' + JSON.stringify(data);
    
    // 加载成功回调
    iframe.onload = function() {
      const content = iframe.contentWindow.document.body.innerHTML;
      
      // 调用成功回调
      if (success) {
        success(JSON.parse(content));
      }
      
      // 移除 iframe
      iframe.remove();
    }
    
    // 加载失败回调
    iframe.onerror = function() {
      if (error) {
        error(data);
      }
      
      // 移除 iframe
      iframe.remove();
    }
  },
  
  // 具体功能封装
  api1: function(data, success, error) {
    this.invoke('myapp://api1', data, success, error);
  },
  
  api2: function(data, success, error) {
    this.invoke('myapp://api2', data, success, error);
  },
  
  api3: function(data, success, error) {
    this.invoke('myapp://api3', data, success, error);
  }
}

// 使用示例
SDK.api1({ param: 'value' }, function(result) {
  console.log('成功', result);
}, function(err) {
  console.log('失败', err);
});
```

**封装要点**：

1. **动态创建 iframe**：不在页面上保留 iframe 元素
2. **隐藏 iframe**：设置 `visibility: hidden`
3. **数据传递**：通过 URL 参数传递 JSON 数据
4. **回调处理**：支持成功和失败回调
5. **资源清理**：加载完成后立即移除 iframe
6. **功能抽象**：将不同的 API 封装成独立方法（api1、api2、api3 等）

**类比微信 JS SDK**：
- `api1` 对应"分享到朋友圈"
- `api2` 对应"预览图片"
- `api3` 对应"扫一扫"
- 每个功能都是对底层 `invoke` 方法的封装

## AI 总结

JS Bridge 是连接 H5 网页与原生 APP 的桥梁技术。实现方式主要有两种：

1. **注册全局 API**：简单直接，但仅适合同步场景
2. **URL Scheme**：通过自定义协议实现，支持异步操作，是目前主流方案

URL Scheme 的核心思路是：APP 拦截 WebView 中的自定义协议请求，直接处理并返回结果，无需真正发起网络请求。通过良好的封装（动态创建/销毁 iframe、回调处理），可以实现优雅的 API 调用体验。微信 JS SDK、支付宝 JS SDK 等都是基于这一原理实现的成熟方案。